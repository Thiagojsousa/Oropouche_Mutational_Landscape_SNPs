############################################################
# Plot SNPs landscape (L/M/S) from LMS_snps_catalogo.csv
# Input: LMS_snps_catalogue.csv (generated by the SNP catalog step)
# Outputs: PNG/SVG/PDF
############################################################

# 1) PARAMETERS ----
PARAM_PLOT <- list(
  workdir        = "/home/user/folder_path/output_files",
  arquivo_entrada = "LMS_snps_catalogue.csv",
  out_dir_fig    = "Figures",
  ncol_facets    = 2,
  width_in       = 10,
  height_in      = 6,
  dpi_png        = 600
)

setwd(PARAM_PLOT$workdir)

# 2) PACKAGES ----
if (!requireNamespace("readr", quietly = TRUE))   install.packages("readr")
if (!requireNamespace("dplyr", quietly = TRUE))   install.packages("dplyr")
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
if (!requireNamespace("stringr", quietly = TRUE)) install.packages("stringr")

library(readr)
library(dplyr)
library(ggplot2)
library(stringr)

if (!dir.exists(PARAM_PLOT$out_dir_fig)) dir.create(PARAM_PLOT$out_dir_fig, recursive = TRUE)

# 3) READ LMS ----
dados_raw <- readr::read_csv(PARAM_PLOT$arquivo_entrada, show_col_types = FALSE)

# 4) UGENE scheme (classes and colours) ----
ugene_colors <- c(
  "Basic/Positively (RHK)"  = "#0000FF",
  "Acidic/Negatively (DE)"  = "#FF0000",
  "Polar/Uncharged (STNQ)"  = "#00FF00",
  "Hydrophobic (AVILM)"     = "#FFFF00",
  "Aromatic (FYW)"          = "#FFA500",
  "Small (CGP)"             = "#808080",
  "Stop"                    = "#000000"
)

ugene_aminoacid_class <- c(
  K="Basic/Positively (RHK)", 
  R="Basic/Positively (RHK)", 
  H="Basic/Positively (RHK)",
  D="Acidic/Negatively (DE)", 
  E="Acidic/Negatively (DE)",
  F="Aromatic (FYW)", 
  W="Aromatic (FYW)", 
  Y="Aromatic (FYW)",
  A="Hydrophobic (AVILM)", 
  V="Hydrophobic (AVILM)", 
  I="Hydrophobic (AVILM)",
  L="Hydrophobic (AVILM)", 
  M="Hydrophobic (AVILM)",
  C="Small (CGP)", 
  G="Small (CGP)", 
  P="Small (CGP)",
  S="Polar/Uncharged (STNQ)", 
  T="Polar/Uncharged (STNQ)", 
  N="Polar/Uncharged (STNQ)", 
  Q="Polar/Uncharged (STNQ)",
  `*`="Stop"
)

# 5) Prepare data (convert LMS to the format expected by the plot) ----
dados <- dados_raw %>%
  mutate(
    Segment        = factor(if ("SEGMENT" %in% names(.)) SEGMENT else CHROM, levels = c("L","M","S")),
    Header         = SAMPLE,
    Amino_position = suppressWarnings(as.numeric(AA_POS)),
    Amino_change   = paste0(AA_REF, ">", AA_ALT),
    Base_position  = POS,
    Base_change    = paste0(REF, ">", ALT),
    Codon_change   = paste0(CODON_REF, ">", CODON_ALT),
    
    # Recode catalogue EFFECT into the classes used by the plotting script
    Mutation_type = case_when(
      EFFECT == "synonymous" ~ "Syn",
      EFFECT %in% c("nonsynonymous", "stop_gained", "stop_lost") ~ "Nonsyn",
      TRUE ~ "Unk"
    ),
    
    aa_ref = AA_REF,
    aa_alt = AA_ALT,
    AA_class_alt = unname(ugene_aminoacid_class[aa_alt])
  ) %>%
  filter(!is.na(Amino_position))

# 6) Automatically order headers (Seq_01, Seq_02, ...) ----
headers <- unique(dados$Header)
if (all(grepl("^Seq_\\d+$", headers))) {
  headers <- headers[order(as.integer(sub("^Seq_", "", headers)))]
}
dados$Header <- factor(dados$Header, levels = headers)

# 7) Aggregate (avoid duplicates) and define y positions ----
dados_plot <- dados %>%
  group_by(Header, Segment, Amino_position, Mutation_type, AA_class_alt) %>%
  summarise(
    Amino_label = paste(unique(gsub(">", ":", Amino_change)), collapse = ", "),
    .groups = "drop"
  ) %>%
  mutate(
    seg_id   = as.numeric(Segment),
    y_bottom = seg_id - 0.25,
    y_top    = seg_id + ifelse(Mutation_type == "Syn", 0.15, 0.30),
    y_point  = y_top
  ) %>%
  arrange(Header, Segment, Amino_position) %>%
  group_by(Header, Segment) %>%
  mutate(
    label_jitter_step = row_number() %% 2,
    y_label = y_point + ifelse(label_jitter_step == 0, 0.15, 0.28)
  ) %>%
  ungroup()

# 8) PLOT ----
p <- ggplot(dados_plot, aes(x = Amino_position, y = y_point)) +
  
  geom_segment(aes(xend = Amino_position, y = y_bottom, yend = y_top),
               color = "grey80", linewidth = 0.4) +
  
  # mutation-type points (Syn/Unk filled; Nonsyn open circle)
  geom_point(
    data = subset(dados_plot, Mutation_type != "Nonsyn"),
    aes(color = Mutation_type),
    size = 2
  ) +
  geom_point(
    data = subset(dados_plot, Mutation_type == "Nonsyn"),
    aes(color = Mutation_type),
    shape = 1, size = 3, stroke = 1
  ) +
  
  geom_point(
    data = subset(dados_plot, Mutation_type == "Nonsyn"),
    aes(fill = AA_class_alt),
    shape = 21, size = 3.2, color = "#e31a1c",
    inherit.aes = TRUE
  ) +
  
  geom_text(
    data = subset(dados_plot, Mutation_type == "Nonsyn"),
    aes(y = y_label, label = Amino_label),
    size = 2, vjust = 0, fontface = "plain",
    inherit.aes = TRUE
  ) +
  
  scale_y_continuous(
    breaks = sort(unique(dados_plot$seg_id)),
    labels = levels(dados_plot$Segment),
    name   = "Segments"
  ) +
  
  scale_x_continuous(
    name   = "Amino acid position",
    breaks = seq(0, max(dados_plot$Amino_position, na.rm = TRUE), by = 500)
  ) +
  
  scale_color_manual(
    name   = "",
    breaks = c("Syn", "Nonsyn", "Unk"),
    values = c(Syn = "#1f78b4", Nonsyn = "#e31a1c", Unk = "grey50"),
    labels = c(
      Syn    = "Synonymous",
      Nonsyn = "Non-synonymous (incl. stop)",
      Unk    = "Unknown/ambiguous"
    )
  ) +
  
  scale_fill_manual(
    name     = "",
    values   = ugene_colors,
    na.value = "white"
  )  +  
  
  facet_wrap(~ Header, ncol = PARAM_PLOT$ncol_facets) +
  
  ggtitle("Mutational landscape of L, M and S segments") +
  theme_bw(base_size = 12) +
  theme(
    panel.grid.minor   = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.background   = element_rect(fill = "grey90"),
    strip.text         = element_text(face = "bold"),
    legend.position    = "top",
    legend.box         = "vertical",
    plot.title         = element_text(hjust = 0.5, face = "bold")
  )

print(p)

# 9) EXPORT ----
ggsave(file.path(PARAM_PLOT$out_dir_fig, "Mutational_landscape_L_M_S.svg"),
       plot = p, width = PARAM_PLOT$width_in, height = PARAM_PLOT$height_in, units = "in")
ggsave(file.path(PARAM_PLOT$out_dir_fig, "Mutational_landscape_L_M_S.pdf"),
       plot = p, width = PARAM_PLOT$width_in, height = PARAM_PLOT$height_in, units = "in")
ggsave(file.path(PARAM_PLOT$out_dir_fig, "Mutational_landscape_L_M_S.png"),
       plot = p, width = PARAM_PLOT$width_in, height = PARAM_PLOT$height_in, units = "in", dpi = PARAM_PLOT$dpi_png)

message("Final figure written to: ",
        file.path(PARAM_PLOT$out_dir_fig, "Mutational_landscape_L_M_S.png"))
